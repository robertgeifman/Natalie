//
//  main.swift
//  Natalie
//
//  Created by Marcin Krzyzanowski on 07/08/16.
//  Copyright Â© 2016 Marcin Krzyzanowski. All rights reserved.
//

import Foundation

func printUsage() {
    print("Usage:")
    print("natalie <storyboard-path or directory>")
}

if CommandLine.arguments.count == 1 {
    printUsage()
    exit(1)
}

var filePaths: [String] = []
let storyboardSuffix = ".storyboard"

for arg in CommandLine.arguments.dropFirst() {
    if arg == "--help" {
        printUsage()
        exit(0)
    } else if arg.hasSuffix(storyboardSuffix) {
        filePaths.append(arg)
    } else if let s = findStoryboards(rootPath: arg, suffix: storyboardSuffix) {
        filePaths.append(contentsOf: s)
    }
}

let storyboardFiles = filePaths.compactMap { try? StoryboardFile(filePath: $0) }

let output = Natalie.process(storyboards: storyboardFiles)
print(output.joined(separator: "\n"))

let natalieBase64String = "Ly8KLy8gIENyZWF0ZWQgYnkgTWFyY2luIEtyenl6YW5vd3NraSBvbiAwNy8wOC8xNi4KLy8gIENvcHlyaWdodCDCqSAyMDE2IE1hcmNpbiBLcnp5emFub3dza2kuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCi8vCi8vICBBZGp1c3RlZCB0byB0aGUgbmVlZHMgb2Ygc3BlY2lmaWMgcHJvamVjdHMgYnkgUm9iZXJ0IEdlaWZtYW4gaW4gMjAxOAovLwoKaW1wb3J0IENvY29hCmltcG9ydCBDcm9zc0tpdAoKZmlsZXByaXZhdGUgZXh0ZW5zaW9uIE9wdGlvbmFsIHdoZXJlIFdyYXBwZWQgPT0gU3RyaW5nIHsKCXZhciB1bndyYXBwZWRTdHJpbmdWYWx1ZTogU3RyaW5nIHsKCQlzd2l0Y2ggc2VsZiB7CgkJY2FzZSAubm9uZTogcmV0dXJuICJuaWwiCgkJY2FzZSAuc29tZShsZXQgdmFsdWUpOiByZXR1cm4gIlwodmFsdWUpIgoJCX0KCX0KfQoKZXh0ZW5zaW9uIFNlcXVlbmNlIHsKICBmdW5jIGZpcnN0PFJlc3VsdD4oXyBpc01hdGNoOiAoSXRlcmF0b3IuRWxlbWVudCkgLT4gUmVzdWx0PykgLT4gUmVzdWx0PyB7CiAgICBmb3IgZWxlbWVudCBpbiBzZWxmIHsKICAgICAgaWYgbGV0IHJlc3VsdCA9IGlzTWF0Y2goZWxlbWVudCkgewogICAgICAgIHJldHVybiByZXN1bHQKICAgICAgfQogICAgfQoKICAgIHJldHVybiBuaWwKICB9Cn0KCmV4dGVuc2lvbiBDb2xsZWN0aW9uIHsKICB2YXIgc2Vjb25kOiBJdGVyYXRvci5FbGVtZW50PyB7CiAgICByZXR1cm4gaW5kZXgoc3RhcnRJbmRleCwgb2Zmc2V0Qnk6IDEsIGxpbWl0ZWRCeTogZW5kSW5kZXgpLm1hcCB7IHNlbGZbJDBdIH0KICB9Cn0KCmV4dGVuc2lvbiBOU09iamVjdCB7CiAgQG5vbm9iamMgZmluYWwgZnVuYyBhc3BlY3RfaG9vayhfIHNlbGVjdG9yOiBTZWxlY3Rvciwgb3B0aW9uczogQXNwZWN0T3B0aW9ucywgYm9keTogQGNvbnZlbnRpb24oYmxvY2spIEBlc2NhcGluZyAoQXNwZWN0SW5mbykgLT4gVm9pZCkgdGhyb3dzIC0+IEFzcGVjdFRva2VuIHsKICAgIHJldHVybiB0cnkgc2VsZi5hc3BlY3RfaG9vayhzZWxlY3Rvciwgd2l0aDogb3B0aW9ucywgdXNpbmdCbG9jazogdW5zYWZlQml0Q2FzdChib2R5LCB0bzogTlNPYmplY3Quc2VsZikpCiAgfQp9CgojaWYgb3MobWFjT1MpCi8vcHVibGljIGVudW0gTmF0YWxpZSB7CnB1YmxpYyBwcm90b2NvbCBBbnlTZWd1ZSB7Cgl2YXIgaWRlbnRpZmllcjogTlNTdG9yeWJvYXJkU2VndWUuSWRlbnRpZmllcj8geyBnZXQgfQoJdmFyIGtpbmQ6IFNlZ3VlS2luZCB7IGdldCB9Cgl2YXIgdHlwZTogTlNWaWV3Q29udHJvbGxlci5UeXBlIHsgZ2V0IH0KfQoKcHVibGljIHN0cnVjdCBTZWd1ZTxEZXN0aW5hdGlvbjpOU1ZpZXdDb250cm9sbGVyPjogQW55U2VndWUgewoJcHVibGljIGxldCBpZGVudGlmaWVyOiBOU1N0b3J5Ym9hcmRTZWd1ZS5JZGVudGlmaWVyPwoJcHVibGljIGxldCBraW5kOiBTZWd1ZUtpbmQKCXB1YmxpYyB2YXIgdHlwZTogTlNWaWV3Q29udHJvbGxlci5UeXBlIHsKCQlyZXR1cm4gRGVzdGluYXRpb24uc2VsZgoJfQoKCXB1YmxpYyBpbml0KF8gaWRlbnRpZmllcjogTlNTdG9yeWJvYXJkU2VndWUuSWRlbnRpZmllcj8gPSBuaWwsIGtpbmQ6IFNlZ3VlS2luZCkgewoJCXNlbGYuaWRlbnRpZmllciA9IGlkZW50aWZpZXIKCQlzZWxmLmtpbmQgPSBraW5kCgl9Cn0KCnB1YmxpYyBzdHJ1Y3QgUmV1c2FibGUgewoJcHVibGljIGxldCBpZGVudGlmaWVyOiBTdHJpbmcKCWxldCBraW5kOiBSZXVzYWJsZUtpbmQ/CglsZXQgdHlwZTogQW55T2JqZWN0LlR5cGUKCXB1YmxpYyBpbml0KF8gaWRlbnRpZmllcjogU3RyaW5nLCBfIGtpbmQ6IFN0cmluZywgXyB0eXBlOiBBbnlPYmplY3QuVHlwZSkgewoJCXNlbGYuaWRlbnRpZmllciA9IGlkZW50aWZpZXIKCQlzZWxmLmtpbmQgPSBSZXVzYWJsZUtpbmQocmF3VmFsdWU6IGtpbmQpCgkJc2VsZi50eXBlID0gdHlwZQoJfQp9Ci8vfQoKcHJvdG9jb2wgSWRlbnRpZmlhYmxlUHJvdG9jb2xfOiBFcXVhdGFibGUgewoJdmFyIHN0b3J5Ym9hcmRJZGVudGlmaWVyOiBOU1N0b3J5Ym9hcmQuU2NlbmVJZGVudGlmaWVyPyB7IGdldCB9Cn0KCmV4dGVuc2lvbiBOU1N0b3J5Ym9hcmRTZWd1ZSB7CglAbm9ub2JqYwoJcHVibGljIHZhciBtYXRjaFBhdHRlcm46IChTdHJpbmc/LCBTdHJpbmc/LCBTdHJpbmc/LCBBbnksIFN0cmluZz8sIFN0cmluZz8sIEFueSkgewoJCWxldCBzb3VyY2UgPSBzb3VyY2VDb250cm9sbGVyIGFzPyBOU1VzZXJJbnRlcmZhY2VJdGVtSWRlbnRpZmljYXRpb24KCQlsZXQgZGVzdGluYXRpb24gPSBkZXN0aW5hdGlvbkNvbnRyb2xsZXIgYXM/IE5TVXNlckludGVyZmFjZUl0ZW1JZGVudGlmaWNhdGlvbgoJCWxldCBzcmNTdG9yeWJvYXJkSUQ6IFN0cmluZz8gPSAoc291cmNlIGFzPyBJZGVudGlmaWFibGVQcm90b2NvbCk/LnN0b3J5Ym9hcmRJZGVudGlmaWVyCgkJbGV0IGRzdFN0b3J5Ym9hcmRJRDogU3RyaW5nPyA9IChkZXN0aW5hdGlvbiBhcz8gSWRlbnRpZmlhYmxlUHJvdG9jb2wpPy5zdG9yeWJvYXJkSWRlbnRpZmllcgoJCXJldHVybiAoaWRlbnRpZmllciwgc291cmNlPy5pZGVudGlmaWVyPy5yYXdWYWx1ZSwgc3JjU3Rvcnlib2FyZElELnVud3JhcHBlZFN0cmluZ1ZhbHVlLCBzb3VyY2VDb250cm9sbGVyLAoJCQlkZXN0aW5hdGlvbj8uaWRlbnRpZmllcj8ucmF3VmFsdWUsIGRzdFN0b3J5Ym9hcmRJRC51bndyYXBwZWRTdHJpbmdWYWx1ZSwgZGVzdGluYXRpb25Db250cm9sbGVyKQoJfQoKCUBub25vYmpjCglwdWJsaWMgZmluYWwgZnVuYyBkZXN0aW5hdGlvblZpZXdDb250cm9sbGVyPERlc3RpbmF0aW9uOiBOU1ZpZXdDb250cm9sbGVyPihvZlR5cGUgdHlwZTogRGVzdGluYXRpb24uVHlwZSkgLT4gRGVzdGluYXRpb24/IHsKCQlyZXR1cm4gKGRlc3RpbmF0aW9uQ29udHJvbGxlciBhcz8gTlNWaWV3Q29udHJvbGxlcik/LmNoaWxkVmlld0NvbnRyb2xsZXIob2ZUeXBlOiB0eXBlKQoJfQp9CgpleHRlbnNpb24gTlNXaW5kb3dDb250cm9sbGVyIHsKCWludGVybmFsIHZhciBzZWd1ZUNvbnRyb2xsZXI6IEFueT8geyByZXR1cm4gc2VsZiB9CgoJcHVibGljIGZ1bmMgcGVyZm9ybTxEZXN0aW5hdGlvbjogTlNWaWV3Q29udHJvbGxlcj4oXyBzZWd1ZTogQW55U2VndWUsIHByZXBhcmU6IEBlc2NhcGluZyAoRGVzdGluYXRpb24pIC0+IFZvaWQgPSB7IF8gaW4gfSkgewoJCWd1YXJkIGxldCBpZGVudGlmaWVyID0gc2VndWUuaWRlbnRpZmllciBlbHNlIHsKCQkJYXNzZXJ0aW9uRmFpbHVyZSgiY2Fubm90IHBlcmZvcm0gc2VndWUgXChzZWd1ZS5raW5kKSB3aXRoIGRlc3RpbmF0aW9uIFwoRGVzdGluYXRpb24uc2VsZikgYmVjYXVzZSBpdCBoYXMgbm8gaWRlbnRpZmVyIikKCQkJcmV0dXJuCgkJfQoKCQlndWFyZCBzZWd1ZS50eXBlID09IERlc3RpbmF0aW9uLnNlbGYgZWxzZSB7CgkJCWZhdGFsRXJyb3IoIlwoc2VndWUudHlwZSkgc2hvdWxkIGJlIHNhbWUgYXMgRGVzdGluYXRpb24gKFwoRGVzdGluYXRpb24uc2VsZikpIikKCQl9CgoJCXBlcmZvcm1TZWd1ZSh3aXRoSWRlbnRpZmllcjogaWRlbnRpZmllcikgeyBbc2VndWVEZXNjcmlwdGlvbiA9IHsgU3RyaW5nKHJlZmxlY3Rpbmc6IHNlZ3VlKSB9XSBzZWd1ZSwgXyBpbgoJCQlndWFyZCBsZXQgZGVzdGluYXRpb24gPSBzZWd1ZS5kZXN0aW5hdGlvblZpZXdDb250cm9sbGVyKG9mVHlwZTogRGVzdGluYXRpb24uc2VsZikgZWxzZSB7CgkJCQlmYXRhbEVycm9yKCJcKHNlZ3VlRGVzY3JpcHRpb24oKSk6IGV4cGVjdGVkIGRlc3RpbmF0aW9uIHZpZXcgY29udHJvbGxlciBoaWVyYXJjaHkgdG8gaW5jbHVkZSBcKERlc3RpbmF0aW9uLnNlbGYpIikKCQkJfQoKCQkJcHJlcGFyZShkZXN0aW5hdGlvbikKCQl9Cgl9CgoJaW50ZXJuYWwgZnVuYyBwZXJmb3JtU2VndWUod2l0aElkZW50aWZpZXIgaWRlbnRpZmllcjogU3RyaW5nLCBzZW5kZXI6IEFueT8gPSBuaWwsIHByZXBhcmU6IEBlc2NhcGluZyAoTlNTdG9yeWJvYXJkU2VndWUsIEFueT8pIC0+IFZvaWQpIHsKCQlfID0gdHJ5ISBhc3BlY3RfaG9vaygjc2VsZWN0b3IoTlNWaWV3Q29udHJvbGxlci5wcmVwYXJlKGZvcjpzZW5kZXI6KSksIG9wdGlvbnM6IC5vcHRpb25BdXRvbWF0aWNSZW1vdmFsKSB7IGluZm8gaW4KCQkJbGV0IGFyZ3VtZW50cyA9IGluZm8uYXJndW1lbnRzKCkhCgkJCXByZXBhcmUoYXJndW1lbnRzLmZpcnN0IGFzISBOU1N0b3J5Ym9hcmRTZWd1ZSwgYXJndW1lbnRzLnNlY29uZCkKCQl9CgoJCXBlcmZvcm1TZWd1ZSh3aXRoSWRlbnRpZmllcjogaWRlbnRpZmllciwgc2VuZGVyOiBzZW5kZXIpCgl9Cn0KCmV4dGVuc2lvbiBOU1ZpZXdDb250cm9sbGVyIHsKCWludGVybmFsIHZhciBzZWd1ZUNvbnRyb2xsZXI6IEFueT8geyByZXR1cm4gc2VsZiB9CgoJcHVibGljIGZ1bmMgcGVyZm9ybTxEZXN0aW5hdGlvbjogTlNWaWV3Q29udHJvbGxlcj4oXyBzZWd1ZTogQW55U2VndWUsIHByZXBhcmU6IEBlc2NhcGluZyAoRGVzdGluYXRpb24pIC0+IFZvaWQgPSB7IF8gaW4gfSkgewoJCWd1YXJkIGxldCBpZGVudGlmaWVyID0gc2VndWUuaWRlbnRpZmllciBlbHNlIHsKCQkJYXNzZXJ0aW9uRmFpbHVyZSgiY2Fubm90IHBlcmZvcm0gc2VndWUgXChzZWd1ZS5raW5kKSB3aXRoIGRlc3RpbmF0aW9uIFwoRGVzdGluYXRpb24uc2VsZikgYmVjYXVzZSBpdCBoYXMgbm8gaWRlbnRpZmVyIikKCQkJcmV0dXJuCgkJfQoKCQlndWFyZCBzZWd1ZS50eXBlID09IERlc3RpbmF0aW9uLnNlbGYgZWxzZSB7CgkJCWZhdGFsRXJyb3IoIlwoc2VndWUudHlwZSkgc2hvdWxkIGJlIHNhbWUgYXMgRGVzdGluYXRpb24gKFwoRGVzdGluYXRpb24uc2VsZikpIikKCQl9CgoJCXBlcmZvcm1TZWd1ZSh3aXRoSWRlbnRpZmllcjogaWRlbnRpZmllcikgeyBbc2VndWVEZXNjcmlwdGlvbiA9IHsgU3RyaW5nKHJlZmxlY3Rpbmc6IHNlZ3VlKSB9XSBzZWd1ZSwgXyBpbgoJCQlndWFyZCBsZXQgZGVzdGluYXRpb24gPSBzZWd1ZS5kZXN0aW5hdGlvblZpZXdDb250cm9sbGVyKG9mVHlwZTogRGVzdGluYXRpb24uc2VsZikgZWxzZSB7CgkJCQlmYXRhbEVycm9yKCJcKHNlZ3VlRGVzY3JpcHRpb24oKSk6IGV4cGVjdGVkIGRlc3RpbmF0aW9uIHZpZXcgY29udHJvbGxlciBoaWVyYXJjaHkgdG8gaW5jbHVkZSBcKERlc3RpbmF0aW9uLnNlbGYpIikKCQkJfQoKCQkJcHJlcGFyZShkZXN0aW5hdGlvbikKCQl9Cgl9CgoJcHVibGljIGZ1bmMgcGVyZm9ybU9yaWdpbmFsPERlc3RpbmF0aW9uPihfIHNlZ3VlOiBTZWd1ZTxEZXN0aW5hdGlvbj4sIHByZXBhcmU6IEBlc2NhcGluZyAoRGVzdGluYXRpb24pIC0+IFZvaWQgPSB7IF8gaW4gfSkgewoJCWd1YXJkIGxldCBpZGVudGlmaWVyID0gc2VndWUuaWRlbnRpZmllciBlbHNlIHsKCQkJYXNzZXJ0aW9uRmFpbHVyZSgiY2Fubm90IHBlcmZvcm0gc2VndWUgXChzZWd1ZS5raW5kKSB3aXRoIGRlc3RpbmF0aW9uIFwoRGVzdGluYXRpb24uc2VsZikgYmVjYXVzZSBpdCBoYXMgbm8gaWRlbnRpZmVyIikKCQkJcmV0dXJuCgkJfQoKCQlndWFyZCBzZWd1ZS50eXBlID09IERlc3RpbmF0aW9uLnNlbGYgZWxzZSB7CgkJCWZhdGFsRXJyb3IoIlwoc2VndWUudHlwZSkgc2hvdWxkIGJlIHNhbWUgYXMgRGVzdGluYXRpb24gKFwoRGVzdGluYXRpb24uc2VsZikpIikKCQl9CgkJCgkJcGVyZm9ybVNlZ3VlKHdpdGhJZGVudGlmaWVyOiBpZGVudGlmaWVyKSB7IFtzZWd1ZURlc2NyaXB0aW9uID0geyBTdHJpbmcocmVmbGVjdGluZzogc2VndWUpIH1dIHNlZ3VlLCBfIGluCgkJCWd1YXJkIGxldCBkZXN0aW5hdGlvbiA9IHNlZ3VlLmRlc3RpbmF0aW9uVmlld0NvbnRyb2xsZXIob2ZUeXBlOiBEZXN0aW5hdGlvbi5zZWxmKSBlbHNlIHsKCQkJCWZhdGFsRXJyb3IoIlwoc2VndWVEZXNjcmlwdGlvbigpKTogZXhwZWN0ZWQgZGVzdGluYXRpb24gdmlldyBjb250cm9sbGVyIGhpZXJhcmNoeSB0byBpbmNsdWRlIFwoRGVzdGluYXRpb24uc2VsZikiKQoJCQl9CgoJCQlwcmVwYXJlKGRlc3RpbmF0aW9uKQoJCX0KCX0KCglpbnRlcm5hbCBmdW5jIHBlcmZvcm1TZWd1ZSh3aXRoSWRlbnRpZmllciBpZGVudGlmaWVyOiBTdHJpbmcsIHNlbmRlcjogQW55PyA9IG5pbCwgcHJlcGFyZTogQGVzY2FwaW5nIChOU1N0b3J5Ym9hcmRTZWd1ZSwgQW55PykgLT4gVm9pZCkgewoJCV8gPSB0cnkhIGFzcGVjdF9ob29rKCNzZWxlY3RvcihOU1ZpZXdDb250cm9sbGVyLnByZXBhcmUoZm9yOnNlbmRlcjopKSwgb3B0aW9uczogLm9wdGlvbkF1dG9tYXRpY1JlbW92YWwpIHsgaW5mbyBpbgoJCQlsZXQgYXJndW1lbnRzID0gaW5mby5hcmd1bWVudHMoKSEKCQkJcHJlcGFyZShhcmd1bWVudHMuZmlyc3QgYXMhIE5TU3Rvcnlib2FyZFNlZ3VlLCBhcmd1bWVudHMuc2Vjb25kKQoJCX0KCgkJcGVyZm9ybVNlZ3VlKHdpdGhJZGVudGlmaWVyOiBpZGVudGlmaWVyLCBzZW5kZXI6IHNlbmRlcikKCX0KfQoKZXh0ZW5zaW9uIE5TVmlld0NvbnRyb2xsZXIgewoJcHVibGljIGZ1bmMgY2hpbGRWaWV3Q29udHJvbGxlcjxDaGlsZDogTlNWaWV3Q29udHJvbGxlcj4ob2ZUeXBlIHR5cGU6IENoaWxkLlR5cGUpIC0+IENoaWxkPyB7CgkJcmV0dXJuIGhpZXJhcmNoeS5maXJzdCB7ICQwIGFzPyBDaGlsZCB9Cgl9CgoJdmFyIGhpZXJhcmNoeTogQW55U2VxdWVuY2U8TlNWaWV3Q29udHJvbGxlcj4gewoJCXJldHVybiBBbnlTZXF1ZW5jZSB7ICgpIC0+IEFueUl0ZXJhdG9yPE5TVmlld0NvbnRyb2xsZXI+IGluCgkJCXZhciBxdWV1ZSA9IFtzZWxmXQoKCQkJcmV0dXJuIEFueUl0ZXJhdG9yIHsKCQkJCWlmIGxldCBuZXh0ID0gcXVldWUucG9wTGFzdCgpIHsKCQkJCQlxdWV1ZS5pbnNlcnQoY29udGVudHNPZjogbmV4dC5jaGlsZHJlbiwgYXQ6IDApCgkJCQkJcmV0dXJuIG5leHQKCQkJCX0gZWxzZSB7CgkJCQkJcmV0dXJuIG5pbAoJCQkJfQoJCQl9CgkJfQoJfQp9CgpleHRlbnNpb24gTlNTcGxpdFZpZXdDb250cm9sbGVyIHsKCXB1YmxpYyBmdW5jIGNvbmZpZ3VyZVZpZXdDb250cm9sbGVycyhfIGNvbmZpZ3VyZTogKE5TVmlld0NvbnRyb2xsZXIpIC0+IFZvaWQpIHsKCQlsZXQgaGllcmFyY2h5ID0gc3BsaXRWaWV3SXRlbXMubGF6eS5mbGF0TWFwIHsgJDAudmlld0NvbnRyb2xsZXIuaGllcmFyY2h5IH0KCQloaWVyYXJjaHkuZm9yRWFjaChjb25maWd1cmUpCgl9Cn0KI2Vsc2UKLy9wdWJsaWMgZW51bSBOYXRhbGllIHsKcHVibGljIHN0cnVjdCBTZWd1ZSB7CglwdWJsaWMgbGV0IGlkZW50aWZpZXI6IFN0cmluZwoJbGV0IGtpbmQ6IFNlZ3VlS2luZD8KCWxldCB0eXBlOiBVSVZpZXdDb250cm9sbGVyLlR5cGUKCXB1YmxpYyBpbml0KF8gaWRlbnRpZmllcjogU3RyaW5nLCBfIGtpbmQ6IFN0cmluZywgXyB0eXBlOiBVSVZpZXdDb250cm9sbGVyLlR5cGUgPSBVSVZpZXdDb250cm9sbGVyLnNlbGYpIHsKCQlzZWxmLmlkZW50aWZpZXIgPSBpZGVudGlmaWVyCgkJc2VsZi5raW5kID0gU2VndWVLaW5kKHJhd1ZhbHVlOiBraW5kKQoJCXNlbGYudHlwZSA9IHR5cGUKCX0KfQoKcHVibGljIHN0cnVjdCBSZXVzYWJsZSB7CglwdWJsaWMgbGV0IGlkZW50aWZpZXI6IFN0cmluZwoJbGV0IGtpbmQ6IFJldXNhYmxlS2luZD8KCWxldCB0eXBlOiBVSVZpZXcuVHlwZQoJcHVibGljIGluaXQoXyBpZGVudGlmaWVyOiBTdHJpbmcsIF8ga2luZDogU3RyaW5nLCBfIHR5cGU6IFR5cGUpIHsKCQlzZWxmLmlkZW50aWZpZXIgPSBpZGVudGlmaWVyCgkJc2VsZi5raW5kID0gUmV1c2FibGVLaW5kKHJhd1ZhbHVlOiBraW5kKQoJCXNlbGYudHlwZSA9IHR5cGUKCX0KfQovL30KZXh0ZW5zaW9uIFVJU3Rvcnlib2FyZFNlZ3VlIHsKCUBub25vYmpjCglwdWJsaWMgZmluYWwgZnVuYyBkZXN0aW5hdGlvblZpZXdDb250cm9sbGVyPERlc3RpbmF0aW9uOiBVSVZpZXdDb250cm9sbGVyPihvZlR5cGUgdHlwZTogRGVzdGluYXRpb24uVHlwZSkgLT4gRGVzdGluYXRpb24/IHsKCQlyZXR1cm4gZGVzdGluYXRpb24uY2hpbGRWaWV3Q29udHJvbGxlcihvZlR5cGU6IHR5cGUpCgl9Cn0KCmV4dGVuc2lvbiBVSVZpZXdDb250cm9sbGVyIHsKCWludGVybmFsIHZhciBzZWd1ZUNvbnRyb2xsZXI6IEFueT8geyByZXR1cm4gc2VsZiB9CgoJcHVibGljIGZ1bmMgcGVyZm9ybTxEZXN0aW5hdGlvbj4oXyBzZWd1ZTogU2VndWU8RGVzdGluYXRpb24+LCBwcmVwYXJlOiBAZXNjYXBpbmcgKERlc3RpbmF0aW9uKSAtPiBWb2lkID0geyBfIGluIH0pIHsKCQlwZXJmb3JtU2VndWUod2l0aElkZW50aWZpZXI6IHNlZ3VlLmlkZW50aWZpZXIpIHsgW3NlZ3VlRGVzY3JpcHRpb24gPSB7IFN0cmluZyhyZWZsZWN0aW5nOiBzZWd1ZSkgfV0gc2VndWUsIF8gaW4KCQkJZ3VhcmQgbGV0IGRlc3RpbmF0aW9uID0gc2VndWUuZGVzdGluYXRpb25WaWV3Q29udHJvbGxlcihvZlR5cGU6IERlc3RpbmF0aW9uLnNlbGYpIGVsc2UgewoJCQkJZmF0YWxFcnJvcigiXChzZWd1ZURlc2NyaXB0aW9uKCkpOiBleHBlY3RlZCBkZXN0aW5hdGlvbiB2aWV3IGNvbnRyb2xsZXIgaGllcmFyY2h5IHRvIGluY2x1ZGUgXChEZXN0aW5hdGlvbi5zZWxmKSIpCgkJCX0KCgkJCXByZXBhcmUoZGVzdGluYXRpb24pCgkJfQoJfQoKCWludGVybmFsIGZ1bmMgcGVyZm9ybVNlZ3VlKHdpdGhJZGVudGlmaWVyIGlkZW50aWZpZXI6IFN0cmluZywgc2VuZGVyOiBBbnk/ID0gbmlsLCBwcmVwYXJlOiBAZXNjYXBpbmcgKFVJU3Rvcnlib2FyZFNlZ3VlLCBBbnk/KSAtPiBWb2lkKSB7CgkJXyA9IHRyeSEgYXNwZWN0X2hvb2soI3NlbGVjdG9yKFVJVmlld0NvbnRyb2xsZXIucHJlcGFyZShmb3I6c2VuZGVyOikpLCBvcHRpb25zOiAub3B0aW9uQXV0b21hdGljUmVtb3ZhbCkgeyBpbmZvIGluCgkJCWxldCBhcmd1bWVudHMgPSBpbmZvLmFyZ3VtZW50cygpIQoJCQlwcmVwYXJlKGFyZ3VtZW50cy5maXJzdCBhcyEgVUlTdG9yeWJvYXJkU2VndWUsIGFyZ3VtZW50cy5zZWNvbmQpCgkJfQoKCQlwZXJmb3JtU2VndWUod2l0aElkZW50aWZpZXI6IGlkZW50aWZpZXIsIHNlbmRlcjogc2VuZGVyKQoJfQp9CgpleHRlbnNpb24gVUlWaWV3Q29udHJvbGxlciB7CglAYXZhaWxhYmxlKCosIHVuYXZhaWxhYmxlKQoJcHVibGljIGZ1bmMgcGVyZm9ybSgpIHsKCQlmYXRhbEVycm9yKCJUaGlzIG1ldGhvZCB3aWxsIG5ldmVyIGJlIGNhbGxlZCwgYW5kIGV4aXN0cyBvbmx5IHRvIHJlbW92ZSBhbiBhcHBhcmVudCBhbWJpZ3VpdHkgcmVzb2x2aW5nIHRoZSBnZW5lcmljIG1ldGhvZCAncGVyZm9ybShfOnByZXBhcmU6KSciKQoJfQp9CgpleHRlbnNpb24gVUlUYWJCYXJDb250cm9sbGVyIHsKICBwdWJsaWMgZnVuYyBjb25maWd1cmVWaWV3Q29udHJvbGxlcnMoXyBjb25maWd1cmU6IChVSVZpZXdDb250cm9sbGVyKSAtPiBWb2lkKSB7CiAgICBsZXQgaGllcmFyY2h5ID0gKHZpZXdDb250cm9sbGVycyA/PyBbXSkubGF6eS5mbGF0TWFwIHsgJDAuaGllcmFyY2h5IH0KICAgIGhpZXJhcmNoeS5mb3JFYWNoKGNvbmZpZ3VyZSkKICB9Cn0KCmV4dGVuc2lvbiBVSVZpZXdDb250cm9sbGVyIHsKCXB1YmxpYyBmdW5jIGNoaWxkVmlld0NvbnRyb2xsZXI8Q2hpbGQ6IFVJVmlld0NvbnRyb2xsZXI+KG9mVHlwZSB0eXBlOiBDaGlsZC5UeXBlKSAtPiBDaGlsZD8gewoJCXJldHVybiBoaWVyYXJjaHkuZmlyc3QgeyAkMCBhcz8gQ2hpbGQgfQoJfQoKCXZhciBoaWVyYXJjaHk6IEFueVNlcXVlbmNlPFVJVmlld0NvbnRyb2xsZXI+IHsKCQlyZXR1cm4gQW55U2VxdWVuY2UgeyAoKSAtPiBBbnlJdGVyYXRvcjxVSVZpZXdDb250cm9sbGVyPiBpbgoJCQl2YXIgcXVldWUgPSBbc2VsZl0KCgkJCXJldHVybiBBbnlJdGVyYXRvciB7CgkJCQlpZiBsZXQgbmV4dCA9IHF1ZXVlLnBvcExhc3QoKSB7CgkJCQkJcXVldWUuaW5zZXJ0KGNvbnRlbnRzT2Y6IG5leHQuY2hpbGRWaWV3Q29udHJvbGxlcnMsIGF0OiAwKQoJCQkJCXJldHVybiBuZXh0CgkJCQl9IGVsc2UgewoJCQkJCXJldHVybiBuaWwKCQkJCX0KCQkJfQoJCX0KCX0KfQojZW5kaWYKCi8vIE1BUks6IC0gU3Rvcnlib2FyZHMKZXh0ZW5zaW9uIE5TU3Rvcnlib2FyZCB7CglmdW5jIGluc3RhbnRpYXRlVmlld0NvbnRyb2xsZXI8VDogTlNXaW5kb3dDb250cm9sbGVyPihvZlR5cGUgdHlwZTogVC5UeXBlKSAtPiBUPyB3aGVyZSBUOiBJZGVudGlmaWFibGVQcm90b2NvbCB7CgkJbGV0IGluc3RhbmNlID0gdHlwZS5pbml0KCkKCQlpZiBsZXQgaWRlbnRpZmllciA9IGluc3RhbmNlLnN0b3J5Ym9hcmRJZGVudGlmaWVyIHsKCQkJcmV0dXJuIHNlbGYuaW5zdGFudGlhdGVDb250cm9sbGVyKHdpdGhJZGVudGlmaWVyOiBpZGVudGlmaWVyKSBhcz8gVAoJCX0KCQlyZXR1cm4gbmlsCgl9CgoJZnVuYyBpbnN0YW50aWF0ZVZpZXdDb250cm9sbGVyPFQ6IE5TVmlld0NvbnRyb2xsZXI+KG9mVHlwZSB0eXBlOiBULlR5cGUpIC0+IFQ/IHdoZXJlIFQ6IElkZW50aWZpYWJsZVByb3RvY29sIHsKCQlsZXQgaW5zdGFuY2UgPSB0eXBlLmluaXQoKQoJCWlmIGxldCBpZGVudGlmaWVyID0gaW5zdGFuY2Uuc3Rvcnlib2FyZElkZW50aWZpZXIgewoJCQlyZXR1cm4gc2VsZi5pbnN0YW50aWF0ZUNvbnRyb2xsZXIod2l0aElkZW50aWZpZXI6IGlkZW50aWZpZXIpIGFzPyBUCgkJfQoJCXJldHVybiBuaWwKCX0KfQoKcHJvdG9jb2wgU3Rvcnlib2FyZCB7CglzdGF0aWMgdmFyIHN0b3J5Ym9hcmQ6IE5TU3Rvcnlib2FyZCB7IGdldCB9CglzdGF0aWMgdmFyIGlkZW50aWZpZXI6IE5TU3Rvcnlib2FyZC5OYW1lIHsgZ2V0IH0KfQoKZXh0ZW5zaW9uIFN0b3J5Ym9hcmQgewoJc3RhdGljIHZhciBzdG9yeWJvYXJkOiBOU1N0b3J5Ym9hcmQgewoJCXJldHVybiBOU1N0b3J5Ym9hcmQobmFtZTogc2VsZi5pZGVudGlmaWVyLCBidW5kbGU6IG5pbCkKCX0KCglzdGF0aWMgZnVuYyBpbnN0YW50aWF0ZUNvbnRyb2xsZXIod2l0aElkZW50aWZpZXIgaWRlbnRpZmllcjogTlNTdG9yeWJvYXJkLlNjZW5lSWRlbnRpZmllcikgLT4gTlNXaW5kb3dDb250cm9sbGVyIHsKCQlyZXR1cm4gc2VsZi5zdG9yeWJvYXJkLmluc3RhbnRpYXRlQ29udHJvbGxlcih3aXRoSWRlbnRpZmllcjogaWRlbnRpZmllcikgYXMhIE5TV2luZG93Q29udHJvbGxlcgoJfQoKCXN0YXRpYyBmdW5jIGluc3RhbnRpYXRlVmlld0NvbnRyb2xsZXI8VDogTlNXaW5kb3dDb250cm9sbGVyPihvZlR5cGUgdHlwZTogVC5UeXBlKSAtPiBUPyB3aGVyZSBUOiBJZGVudGlmaWFibGVQcm90b2NvbCB7CgkJcmV0dXJuIHNlbGYuc3Rvcnlib2FyZC5pbnN0YW50aWF0ZVZpZXdDb250cm9sbGVyKG9mVHlwZTogdHlwZSkKCX0KCglzdGF0aWMgZnVuYyBpbnN0YW50aWF0ZUNvbnRyb2xsZXIod2l0aElkZW50aWZpZXIgaWRlbnRpZmllcjogTlNTdG9yeWJvYXJkLlNjZW5lSWRlbnRpZmllcikgLT4gTlNWaWV3Q29udHJvbGxlciB7CgkJcmV0dXJuIHNlbGYuc3Rvcnlib2FyZC5pbnN0YW50aWF0ZUNvbnRyb2xsZXIod2l0aElkZW50aWZpZXI6IGlkZW50aWZpZXIpIGFzISBOU1ZpZXdDb250cm9sbGVyCgl9CgoJc3RhdGljIGZ1bmMgaW5zdGFudGlhdGVWaWV3Q29udHJvbGxlcjxUOiBOU1ZpZXdDb250cm9sbGVyPihvZlR5cGUgdHlwZTogVC5UeXBlKSAtPiBUPyB3aGVyZSBUOiBJZGVudGlmaWFibGVQcm90b2NvbCB7CgkJcmV0dXJuIHNlbGYuc3Rvcnlib2FyZC5pbnN0YW50aWF0ZVZpZXdDb250cm9sbGVyKG9mVHlwZTogdHlwZSkKCX0KfQoKLy8gTUFSSzogLSBSZXVzYWJsZUtpbmQKcHVibGljIGVudW0gUmV1c2FibGVLaW5kOiBTdHJpbmcsIEN1c3RvbVN0cmluZ0NvbnZlcnRpYmxlIHsKI2lmIG9zKG1hY09TKQoJY2FzZSB0YWJsZUNlbGxWaWV3ID0gInRhYmxlQ2VsbFZpZXciCgljYXNlIGNvbGxlY3Rpb25WaWV3SXRlbSA9ICJjb2xsZWN0aW9uVmlld0l0ZW0iCiNlbHNlCgljYXNlIHRhYmxlVmlld0NlbGwgPSAidGFibGVWaWV3Q2VsbCIKCWNhc2UgY29sbGVjdGlvblZpZXdDZWxsID0gImNvbGxlY3Rpb25WaWV3Q2VsbCIKI2VuZGlmCglwdWJsaWMgdmFyIGRlc2NyaXB0aW9uOiBTdHJpbmcgeyByZXR1cm4gc2VsZi5yYXdWYWx1ZSB9Cn0KCi8vIE1BUks6IC0gU2VndWVLaW5kCnB1YmxpYyBlbnVtIFNlZ3VlS2luZDogU3RyaW5nLCBDdXN0b21TdHJpbmdDb252ZXJ0aWJsZSB7CgljYXNlIHJlbGF0aW9uc2hpcCA9ICJyZWxhdGlvbnNoaXAiCgljYXNlIHNob3cgPSAic2hvdyIKCWNhc2Ugc2hlZXQgPSAic2hlZXQiCgljYXNlIHByZXNlbnRhdGlvbiA9ICJwcmVzZW50YXRpb24iCgljYXNlIGVtYmVkID0gImVtYmVkIgoJY2FzZSB1bndpbmQgPSAidW53aW5kIgoJY2FzZSBwdXNoID0gInB1c2giCgljYXNlIG1vZGFsID0gIm1vZGFsIgoJY2FzZSBwb3BvdmVyID0gInBvcG92ZXIiCgljYXNlIHJlcGxhY2UgPSAicmVwbGFjZSIKCWNhc2UgY3VzdG9tID0gImN1c3RvbSIKCglwdWJsaWMgdmFyIGRlc2NyaXB0aW9uOiBTdHJpbmcgeyByZXR1cm4gc2VsZi5yYXdWYWx1ZSB9Cn0KCi8vIE1BUks6IC0gSWRlbnRpZmlhYmxlUHJvdG9jb2wKcHJvdG9jb2wgSWRlbnRpZmlhYmxlUHJvdG9jb2wgey8vIDogRXF1YXRhYmxlIHsKCXZhciBzdG9yeWJvYXJkSWRlbnRpZmllcjogTlNTdG9yeWJvYXJkLlNjZW5lSWRlbnRpZmllcj8geyBnZXQgfQp9CgovLyBNQVJLOiAtIFNlZ3VlUHJvdG9jb2wKcHJvdG9jb2wgU2VndWVQcm90b2NvbCB7Cgl2YXIgaWRlbnRpZmllcjogTlNTdG9yeWJvYXJkU2VndWUuSWRlbnRpZmllcj8geyBnZXQgfQp9CgpmdW5jID09PFQ6IFNlZ3VlUHJvdG9jb2wsIFU6IFNlZ3VlUHJvdG9jb2w+KGxoczogVCwgcmhzOiBVKSAtPiBCb29sIHsKCXJldHVybiBsaHMuaWRlbnRpZmllciA9PSByaHMuaWRlbnRpZmllcgp9CgpmdW5jIH49PFQ6IFNlZ3VlUHJvdG9jb2wsIFU6IFNlZ3VlUHJvdG9jb2w+KGxoczogVCwgcmhzOiBVKSAtPiBCb29sIHsKCXJldHVybiBsaHMuaWRlbnRpZmllciA9PSByaHMuaWRlbnRpZmllcgp9CgpmdW5jID09PFQ6IFNlZ3VlUHJvdG9jb2w+KGxoczogVCwgcmhzOiBOU1N0b3J5Ym9hcmRTZWd1ZS5JZGVudGlmaWVyKSAtPiBCb29sIHsKCXJldHVybiBsaHMuaWRlbnRpZmllciA9PSByaHMKfQoKZnVuYyB+PTxUOiBTZWd1ZVByb3RvY29sPihsaHM6IFQsIHJoczogTlNTdG9yeWJvYXJkU2VndWUuSWRlbnRpZmllcikgLT4gQm9vbCB7CglyZXR1cm4gbGhzLmlkZW50aWZpZXIgPT0gcmhzCn0KCmZ1bmMgPT08VDogU2VndWVQcm90b2NvbD4obGhzOiBOU1N0b3J5Ym9hcmRTZWd1ZS5JZGVudGlmaWVyLCByaHM6IFQpIC0+IEJvb2wgewoJcmV0dXJuIGxocyA9PSByaHMuaWRlbnRpZmllcgp9CgpmdW5jIH49PFQ6IFNlZ3VlUHJvdG9jb2w+KGxoczogTlNTdG9yeWJvYXJkU2VndWUuSWRlbnRpZmllciwgcmhzOiBUKSAtPiBCb29sIHsKCXJldHVybiBsaHMgPT0gcmhzLmlkZW50aWZpZXIKfQoKLy8gTUFSSzogLSBQcm90b2NvbCBJbXBsZW1lbnRhdGlvbgpleHRlbnNpb24gTlNTdG9yeWJvYXJkU2VndWU6IFNlZ3VlUHJvdG9jb2wgewp9CgovLyBNQVJLOiAtIE5TVmlld0NvbnRyb2xsZXIgZXh0ZW5zaW9uCmV4dGVuc2lvbiBOU1ZpZXdDb250cm9sbGVyIHsKCWZ1bmMgcGVyZm9ybTxUOiBTZWd1ZVByb3RvY29sPihzZWd1ZTogVCwgc2VuZGVyOiBBbnk/KSB7CgkJaWYgbGV0IGlkZW50aWZpZXIgPSBzZWd1ZS5pZGVudGlmaWVyIHsKCQkJcGVyZm9ybVNlZ3VlKHdpdGhJZGVudGlmaWVyOiBpZGVudGlmaWVyLCBzZW5kZXI6IHNlbmRlcikKCQl9Cgl9CgoJZnVuYyBwZXJmb3JtPFQ6IFNlZ3VlUHJvdG9jb2w+KHNlZ3VlOiBUKSB7CgkJcGVyZm9ybShzZWd1ZTogc2VndWUsIHNlbmRlcjogbmlsKQoJfQp9CgovLyBNQVJLOiAtIE5TV2luZG93Q29udHJvbGxlciBleHRlbnNpb24KZXh0ZW5zaW9uIE5TV2luZG93Q29udHJvbGxlciB7CglmdW5jIHBlcmZvcm08VDogU2VndWVQcm90b2NvbD4oc2VndWU6IFQsIHNlbmRlcjogQW55PykgewoJCWlmIGxldCBpZGVudGlmaWVyID0gc2VndWUuaWRlbnRpZmllciB7CgkJCXBlcmZvcm1TZWd1ZSh3aXRoSWRlbnRpZmllcjogaWRlbnRpZmllciwgc2VuZGVyOiBzZW5kZXIpCgkJfQoJfQoKCWZ1bmMgcGVyZm9ybTxUOiBTZWd1ZVByb3RvY29sPihzZWd1ZTogVCkgewoJCXBlcmZvcm0oc2VndWU6IHNlZ3VlLCBzZW5kZXI6IG5pbCkKCX0KfQoKLy8gTUFSSzogLSBSZXVzYWJsZVZpZXdQcm90b2NvbAojaWYgb3MobWFjT1MpCnByb3RvY29sIFJldXNhYmxlVmlld1Byb3RvY29sIHsKCXZhciBzdG9yeWJvYXJkSWRlbnRpZmllcjogTlNVc2VySW50ZXJmYWNlSXRlbUlkZW50aWZpZXI/IHsgZ2V0IH0KCXZhciB2aWV3VHlwZTogTlNWaWV3LlR5cGU/IHsgZ2V0IH0KfQoKLy8gTUFSSzogLSBOU0NvbGxlY3Rpb25WaWV3CmV4dGVuc2lvbiBOU0NvbGxlY3Rpb25WaWV3IHsKCWZ1bmMgZGVxdWV1ZTxUOiBSZXVzYWJsZVZpZXdQcm90b2NvbD4ocmV1c2FibGU6IFQsIGZvciBpbmRleFBhdGg6IEluZGV4UGF0aCkgLT4gTlNDb2xsZWN0aW9uVmlld0l0ZW0/IHsKCQlpZiBsZXQgaWRlbnRpZmllciA9IHJldXNhYmxlLnN0b3J5Ym9hcmRJZGVudGlmaWVyIHsKCQkJcmV0dXJuIG1ha2VJdGVtKHdpdGhJZGVudGlmaWVyOiBpZGVudGlmaWVyLCBmb3I6IGluZGV4UGF0aCkKCQl9CgkJcmV0dXJuIG5pbAoJfQoKCWZ1bmMgcmVnaXN0ZXI8VDogUmV1c2FibGVWaWV3UHJvdG9jb2w+KHJldXNhYmxlOiBUKSB7CgkJaWYgbGV0IHR5cGUgPSByZXVzYWJsZS52aWV3VHlwZSwgbGV0IGlkZW50aWZpZXIgPSByZXVzYWJsZS5zdG9yeWJvYXJkSWRlbnRpZmllciB7CgkJCXJlZ2lzdGVyKHR5cGUsIGZvckl0ZW1XaXRoSWRlbnRpZmllcjogaWRlbnRpZmllcikKCQl9Cgl9CgoJZnVuYyBkZXF1ZXVlUmV1c2FibGVWaWV3PFQ6IFJldXNhYmxlVmlld1Byb3RvY29sPihvZktpbmQgZWxlbWVudEtpbmQ6IE5TQ29sbGVjdGlvblZpZXcuU3VwcGxlbWVudGFyeUVsZW1lbnRLaW5kLCByZXVzYWJsZTogVCwgZm9yIGluZGV4UGF0aDogSW5kZXhQYXRoKSAtPiBOU1ZpZXc/IHsKCQlpZiBsZXQgaWRlbnRpZmllciA9IHJldXNhYmxlLnN0b3J5Ym9hcmRJZGVudGlmaWVyIHsKCQkJcmV0dXJuIG1ha2VTdXBwbGVtZW50YXJ5VmlldyhvZktpbmQ6IGVsZW1lbnRLaW5kLCB3aXRoSWRlbnRpZmllcjogaWRlbnRpZmllciwgZm9yOiBpbmRleFBhdGgpCgkJfQoJCXJldHVybiBuaWwKCX0KCglmdW5jIHJlZ2lzdGVyUmV1c2FibGVWaWV3PFQ6IFJldXNhYmxlVmlld1Byb3RvY29sPihvZktpbmQgZWxlbWVudEtpbmQ6IE5TQ29sbGVjdGlvblZpZXcuU3VwcGxlbWVudGFyeUVsZW1lbnRLaW5kLCByZXVzYWJsZTogVCkgewoJCWlmIGxldCB0eXBlID0gcmV1c2FibGUudmlld1R5cGUsIGxldCBpZGVudGlmaWVyID0gcmV1c2FibGUuc3Rvcnlib2FyZElkZW50aWZpZXIgewoJCQlyZWdpc3Rlcih0eXBlLCBmb3JTdXBwbGVtZW50YXJ5Vmlld09mS2luZDogZWxlbWVudEtpbmQsIHdpdGhJZGVudGlmaWVyOiBpZGVudGlmaWVyKQoJCX0KCX0KfQovLyBNQVJLOiAtIE5TVGFibGVWaWV3CmV4dGVuc2lvbiBOU1RhYmxlVmlldyB7CglmdW5jIGRlcXVldWU8VDogUmV1c2FibGVWaWV3UHJvdG9jb2w+KHJldXNhYmxlOiBULCBmb3I6IEluZGV4UGF0aCkgLT4gTlNWaWV3PyB7CgkJaWYgbGV0IGlkZW50aWZpZXIgPSByZXVzYWJsZS5zdG9yeWJvYXJkSWRlbnRpZmllciB7CgkJCXJldHVybiBtYWtlVmlldyh3aXRoSWRlbnRpZmllcjogaWRlbnRpZmllciwgb3duZXI6IG5pbCkKCQl9CgkJcmV0dXJuIG5pbAoJfQoKCWZ1bmMgcmVnaXN0ZXI8VDogUmV1c2FibGVWaWV3UHJvdG9jb2w+KHJldXNhYmxlOiBULCBuaWJOYW1lOiBOU05pYi5OYW1lLCBidW5kbGUgYnVuZGxlT3JOaWw6IEJ1bmRsZT8pIHsKCQlpZiBsZXQgaWRlbnRpZmllciA9IHJldXNhYmxlLnN0b3J5Ym9hcmRJZGVudGlmaWVyLAoJCQlsZXQgbmliID0gTlNOaWIobmliTmFtZWQ6IG5pYk5hbWUsIGJ1bmRsZTogYnVuZGxlT3JOaWwpIHsKCQkJcmVnaXN0ZXIobmliLCBmb3JJZGVudGlmaWVyOiBpZGVudGlmaWVyKQoJCX0KCX0KCglmdW5jIHJlZ2lzdGVyPFQ6IFJldXNhYmxlVmlld1Byb3RvY29sPihyZXVzYWJsZTogVCwgbmliRGF0YTogRGF0YSwgYnVuZGxlIGJ1bmRsZU9yTmlsOiBCdW5kbGU/KSB7CgkJaWYgbGV0IGlkZW50aWZpZXIgPSByZXVzYWJsZS5zdG9yeWJvYXJkSWRlbnRpZmllciB7CgkJCWxldCBuaWIgPSBOU05pYihuaWJEYXRhOiBuaWJEYXRhLCBidW5kbGU6IGJ1bmRsZU9yTmlsKQoJCQlyZWdpc3RlcihuaWIsIGZvcklkZW50aWZpZXI6IGlkZW50aWZpZXIpCgkJfQoJfQp9CgpleHRlbnNpb24gTlNUYWJsZUNlbGxWaWV3OiBSZXVzYWJsZVZpZXdQcm90b2NvbCB7CglwdWJsaWMgdmFyIHZpZXdUeXBlOiBOU1ZpZXcuVHlwZT8geyByZXR1cm4gdHlwZShvZjogc2VsZikgfQoJcHVibGljIHZhciBzdG9yeWJvYXJkSWRlbnRpZmllcjogTlNVc2VySW50ZXJmYWNlSXRlbUlkZW50aWZpZXI/IHsgcmV0dXJuIHNlbGYuaWRlbnRpZmllciB9Cn0KCmV4dGVuc2lvbiBOU1RhYmxlSGVhZGVyVmlldzogUmV1c2FibGVWaWV3UHJvdG9jb2wgewoJcHVibGljIHZhciB2aWV3VHlwZTogTlNWaWV3LlR5cGU/IHsgcmV0dXJuIHR5cGUob2Y6IHNlbGYpIH0KCXB1YmxpYyB2YXIgc3Rvcnlib2FyZElkZW50aWZpZXI6IE5TVXNlckludGVyZmFjZUl0ZW1JZGVudGlmaWVyPyB7IHJldHVybiBzZWxmLmlkZW50aWZpZXIgfQp9CgpleHRlbnNpb24gTlNUYWJsZVJvd1ZpZXc6IFJldXNhYmxlVmlld1Byb3RvY29sIHsKCXB1YmxpYyB2YXIgdmlld1R5cGU6IE5TVmlldy5UeXBlPyB7IHJldHVybiB0eXBlKG9mOiBzZWxmKSB9CglwdWJsaWMgdmFyIHN0b3J5Ym9hcmRJZGVudGlmaWVyOiBOU1VzZXJJbnRlcmZhY2VJdGVtSWRlbnRpZmllcj8geyByZXR1cm4gc2VsZi5pZGVudGlmaWVyIH0KfQojZWxzZQpwcm90b2NvbCBSZXVzYWJsZVZpZXdQcm90b2NvbCA6IElkZW50aWZpYWJsZVByb3RvY29sIHsKCXZhciB2aWV3VHlwZTogVUlWaWV3LlR5cGU/IHsgZ2V0IH0KfQoKLy8gTUFSSzogLSBVSUNvbGxlY3Rpb25WaWV3CmV4dGVuc2lvbiBVSUNvbGxlY3Rpb25WaWV3IHsKCWZ1bmMgZGVxdWV1ZTxUOiBSZXVzYWJsZVZpZXdQcm90b2NvbD4ocmV1c2FibGU6IFQsIGZvcjogSW5kZXhQYXRoKSAtPiBVSUNvbGxlY3Rpb25WaWV3Q2VsbD8gewoJCWlmIGxldCBpZGVudGlmaWVyID0gcmV1c2FibGUuc3Rvcnlib2FyZElkZW50aWZpZXIgewoJCQlyZXR1cm4gZGVxdWV1ZVJldXNhYmxlQ2VsbCh3aXRoUmV1c2VJZGVudGlmaWVyOiBpZGVudGlmaWVyLCBmb3I6IGBmb3JgKQoJCX0KCQlyZXR1cm4gbmlsCgl9CgoJZnVuYyByZWdpc3RlcjxUOiBSZXVzYWJsZVZpZXdQcm90b2NvbD4ocmV1c2FibGU6IFQpIHsKCQlpZiBsZXQgdHlwZSA9IHJldXNhYmxlLnZpZXdUeXBlLCBsZXQgaWRlbnRpZmllciA9IHJldXNhYmxlLnN0b3J5Ym9hcmRJZGVudGlmaWVyIHsKCQkJcmVnaXN0ZXIodHlwZSwgZm9yQ2VsbFdpdGhSZXVzZUlkZW50aWZpZXI6IGlkZW50aWZpZXIpCgkJfQoJfQoKCWZ1bmMgZGVxdWV1ZVJldXNhYmxlU3VwcGxlbWVudGFyeVZpZXdPZktpbmQ8VDogUmV1c2FibGVWaWV3UHJvdG9jb2w+KGVsZW1lbnRLaW5kOiBTdHJpbmcsIHdpdGhSZXVzYWJsZSByZXVzYWJsZTogVCwgZm9yOiBJbmRleFBhdGgpIC0+IFVJQ29sbGVjdGlvblJldXNhYmxlVmlldz8gewoJCWlmIGxldCBpZGVudGlmaWVyID0gcmV1c2FibGUuc3Rvcnlib2FyZElkZW50aWZpZXIgewoJCQlyZXR1cm4gZGVxdWV1ZVJldXNhYmxlU3VwcGxlbWVudGFyeVZpZXcob2ZLaW5kOiBlbGVtZW50S2luZCwgd2l0aFJldXNlSWRlbnRpZmllcjogaWRlbnRpZmllciwgZm9yOiBgZm9yYCkKCQl9CgkJcmV0dXJuIG5pbAoJfQoKCWZ1bmMgcmVnaXN0ZXI8VDogUmV1c2FibGVWaWV3UHJvdG9jb2w+KHJldXNhYmxlOiBULCBmb3JTdXBwbGVtZW50YXJ5Vmlld09mS2luZCBlbGVtZW50S2luZDogU3RyaW5nKSB7CgkJaWYgbGV0IHR5cGUgPSByZXVzYWJsZS52aWV3VHlwZSwgbGV0IGlkZW50aWZpZXIgPSByZXVzYWJsZS5zdG9yeWJvYXJkSWRlbnRpZmllciB7CgkJCXJlZ2lzdGVyKHR5cGUsIGZvclN1cHBsZW1lbnRhcnlWaWV3T2ZLaW5kOiBlbGVtZW50S2luZCwgd2l0aFJldXNlSWRlbnRpZmllcjogaWRlbnRpZmllcikKCQl9Cgl9Cn0KLy8gTUFSSzogLSBVSVRhYmxlVmlldwpleHRlbnNpb24gVUlUYWJsZVZpZXcgewoJZnVuYyBkZXF1ZXVlPFQ6IFJldXNhYmxlVmlld1Byb3RvY29sPihyZXVzYWJsZTogVCwgZm9yOiBJbmRleFBhdGgpIC0+IFVJVGFibGVWaWV3Q2VsbD8gewoJCWlmIGxldCBpZGVudGlmaWVyID0gcmV1c2FibGUuc3Rvcnlib2FyZElkZW50aWZpZXIgewoJCQlyZXR1cm4gZGVxdWV1ZVJldXNhYmxlQ2VsbCh3aXRoSWRlbnRpZmllcjogaWRlbnRpZmllciwgZm9yOiBgZm9yYCkKCQl9CgkJcmV0dXJuIG5pbAoJfQoKCWZ1bmMgcmVnaXN0ZXI8VDogUmV1c2FibGVWaWV3UHJvdG9jb2w+KHJldXNhYmxlOiBUKSB7CgkJaWYgbGV0IHR5cGUgPSByZXVzYWJsZS52aWV3VHlwZSwgbGV0IGlkZW50aWZpZXIgPSByZXVzYWJsZS5zdG9yeWJvYXJkSWRlbnRpZmllciB7CgkJCXJlZ2lzdGVyKHR5cGUsIGZvckNlbGxSZXVzZUlkZW50aWZpZXI6IGlkZW50aWZpZXIpCgkJfQoJfQoKCWZ1bmMgZGVxdWV1ZVJldXNhYmxlSGVhZGVyRm9vdGVyPFQ6IFJldXNhYmxlVmlld1Byb3RvY29sPihfIHJldXNhYmxlOiBUKSAtPiBVSVRhYmxlVmlld0hlYWRlckZvb3RlclZpZXc/IHsKCQlpZiBsZXQgaWRlbnRpZmllciA9IHJldXNhYmxlLnN0b3J5Ym9hcmRJZGVudGlmaWVyIHsKCQkJcmV0dXJuIGRlcXVldWVSZXVzYWJsZUhlYWRlckZvb3RlclZpZXcod2l0aElkZW50aWZpZXI6IGlkZW50aWZpZXIpCgkJfQoJCXJldHVybiBuaWwKCX0KCglmdW5jIHJlZ2lzdGVyUmV1c2FibGVIZWFkZXJGb290ZXI8VDogUmV1c2FibGVWaWV3UHJvdG9jb2w+KF8gcmV1c2FibGU6IFQpIHsKCQlpZiBsZXQgdHlwZSA9IHJldXNhYmxlLnZpZXdUeXBlLCBsZXQgaWRlbnRpZmllciA9IHJldXNhYmxlLnN0b3J5Ym9hcmRJZGVudGlmaWVyIHsKCQkJIHJlZ2lzdGVyKHR5cGUsIGZvckhlYWRlckZvb3RlclZpZXdSZXVzZUlkZW50aWZpZXI6IGlkZW50aWZpZXIpCgkJfQoJfQp9CgpleHRlbnNpb24gVUlUYWJsZVZpZXdDZWxsOiBSZXVzYWJsZVZpZXdQcm90b2NvbCB7CglwdWJsaWMgdmFyIHZpZXdUeXBlOiBVSVZpZXcuVHlwZT8geyByZXR1cm4gdHlwZShvZjogc2VsZikgfQoJcHVibGljIHZhciBzdG9yeWJvYXJkSWRlbnRpZmllcjogU3RyaW5nPyB7IHJldHVybiBzZWxmLnJldXNhYmxlSWRlbnRpZmllciB9Cn0KCmV4dGVuc2lvbiBVSUNvbGxlY3Rpb25SZXVzYWJsZVZpZXc6IFJldXNhYmxlVmlld1Byb3RvY29sIHsKCXB1YmxpYyB2YXIgdmlld1R5cGU6IFVJVmlldy5UeXBlPyB7IHJldHVybiB0eXBlKG9mOiBzZWxmKSB9CglwdWJsaWMgdmFyIHN0b3J5Ym9hcmRJZGVudGlmaWVyOiBTdHJpbmc/IHsgcmV0dXJuIHNlbGYucmV1c2FibGVJZGVudGlmaWVyIH0KfQojZW5kaWYgLy8gb3MoaU9TKQoKZnVuYyA9PTxUOiBSZXVzYWJsZVZpZXdQcm90b2NvbCwgVTogUmV1c2FibGVWaWV3UHJvdG9jb2w+KGxoczogVCwgcmhzOiBVKSAtPiBCb29sIHsKCXJldHVybiBsaHMuc3Rvcnlib2FyZElkZW50aWZpZXIgPT0gcmhzLnN0b3J5Ym9hcmRJZGVudGlmaWVyCn0K"

do {
	if let natalieBase64Data = try Base64.decode(natalieBase64String),
		let string = String(data: natalieBase64Data, encoding: .utf8) {
		print(string)
	}
} catch {}
exit(0)
